name: Test
on: push
jobs:
  test:
    name: test
    runs-on: ubuntu-18.04
    strategy:
      max-parallel: 1
      matrix:
        erlang_version:
        - "22.3"
        - "23.1"
    timeout-minutes: 20
    steps:
    - name: CHECKOUT REPOSITORY
      uses: actions/checkout@v2
    - name: CONFIGURE OTP & ELIXIR
      uses: actions/setup-elixir@v1
      with:
        otp-version: ${{ matrix.erlang_version }}
        # https://github.com/elixir-lang/elixir/releases
        elixir-version: 1.10.4
    - name: INSTALL BAZELISK
      run: |
        curl -LO "https://github.com/bazelbuild/bazelisk/releases/download/v1.1.0/bazelisk-linux-amd64"
        mkdir -p "${GITHUB_WORKSPACE}/bin/"
        mv bazelisk-linux-amd64 "${GITHUB_WORKSPACE}/bin/bazel"
        chmod +x "${GITHUB_WORKSPACE}/bin/bazel"
    - name: RUN TESTS
      run: |
        erl -eval '{ok, Version} = file:read_file(filename:join([code:root_dir(), "releases", erlang:system_info(otp_release), "OTP_VERSION"])), io:fwrite(Version), halt().' -noshell
        mix --version

        ERLANG_HOME="$(dirname $(dirname $(which erl)))"
        ELIXIR_HOME="$(dirname $(dirname $(which iex)))"
        "${GITHUB_WORKSPACE}/bin/bazel" test //... \
          --//bazel_erlang:erlang_home=${ERLANG_HOME} \
          --//bazel_erlang:elixir_home=${ELIXIR_HOME} \
          --//bazel_erlang:mix_archives=/home/runner/.mix/archives \
          --test_tag_filters="erlang-${{ matrix.erlang_version }}" \
          --build_tests_only \
          --test_verbose_timeout_warnings \
          --verbose_failures
    - name: RESOVLE TESTLOGS
      id: resolve_logs
      if: success() || failure()
      run: |
        echo "::set-output name=bin::$(readlink -f bazel-bin)"
        echo "::set-output name=testlogs::$(readlink -f bazel-testlogs)"
    - name: CAPTURE BIN
      uses: actions/upload-artifact@v2
      if: success() || failure()
      with:
        name: bazel-bin-${{ matrix.erlang_version }}
        path: ${{ steps.resolve_logs.outputs.bin }}
    - name: CAPTURE LOGS
      uses: actions/upload-artifact@v2
      if: success() || failure()
      with:
        name: bazel-testlogs-${{ matrix.erlang_version }}
        path: ${{ steps.resolve_logs.outputs.testlogs }}
